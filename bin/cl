#!/bin/bash

# Claude AGENTS/CLAUDE.md Mode Wrapper Script
# Usage: cl /YON | /YOFF | /STATUS | /HELP | [claude commands]

# Barvy pro výstup
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RESET='\033[0m'
BOLD='\033[1m'

# Soubor pro uložení stavu
STATE_FILE="$HOME/.claude_agents_state"

# Funkce pro čtení aktuálního režimu
get_mode() {
    if [ -f "$STATE_FILE" ]; then
        cat "$STATE_FILE"
    else
        echo "CLAUDE"  # Výchozí je bezpečný režim
    fi
}

# Funkce pro nastavení režimu
set_mode() {
    echo "$1" > "$STATE_FILE"
}

# Zpracování argumentů
case "$1" in
    /YON)
        echo -e "${YELLOW}${BOLD}🔥 ACTIVATING AGENTS MODE 🔥${RESET}"
        echo -e "${RED}⚠️  WARNING: All CLAUDE.md will be ignored!${RESET}"
        echo -e "${RED}⚠️  Claude will use AGENTS.md instead${RESET}"
        set_mode "AGENTS"
        echo -e "${YELLOW}✓ AGENTS mode is now ON${RESET}"
        ;;
        
    /YOFF)
        echo -e "${CYAN}${BOLD}🛡️  ACTIVATING CLAUDE MODE 🛡️${RESET}"
        echo -e "${GREEN}✓ CLAUDE.md will be enabled${RESET}"
        set_mode "CLAUDE"
        echo -e "${CYAN}✓ AGENTS mode is now OFF (CLAUDE.md mode ON)${RESET}"
        ;;
        
    /STATUS)
        MODE=$(get_mode)
        echo -e "${BOLD}Claude CLI Status:${RESET}"
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        if [ "$MODE" = "AGENTS" ]; then
            echo -e "Mode: ${YELLOW}${BOLD}AGENTS${RESET} 🔥"
            echo -e "Instructions: ${RED}CLAUDE.md will be ignored${RESET}"
            echo -e "Instructions: ${GREEN}AGENTS.md will be used${RESET}"
        else
            echo -e "Mode: ${CYAN}${BOLD}CLAUDE${RESET} 🛡️"
            echo -e "Instructions: ${GREEN}CLAUDE.md will be used${RESET}"
            echo -e "Instructions: ${RED}AGENTS.md will be ignored${RESET}"
        fi
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        ;;
        
    /HELP|/H|/?)
        echo -e "${BOLD}Claude CLI Wrapper - Help${RESET}"
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo -e "${CYAN}cl /YON${RESET}     - Enable AGENTS mode (ignore CLAUDE.md)"
        echo -e "${CYAN}cl /YOFF${RESET}    - Disable AGENTS mode (use CLAUDE.md)"
        echo -e "${CYAN}cl /STATUS${RESET}  - Show current mode"
        echo -e "${CYAN}cl /HELP${RESET}    - Show this help"
        echo -e "${CYAN}cl [args]${RESET}   - Run claude with current mode"
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo -e ""
        echo -e "${BOLD}Examples:${RESET}"
        echo -e "  cl /YON                    # Enable AGENTS mode"
        echo -e "  cl /YOFF                   # Enable CLAUDE.md mode"
        echo -e "  cl \"write a function\"      # Run Claude in current mode"
        echo -e ""
        echo -e "${BOLD}Mode Persistence:${RESET}"
        echo -e "Your mode choice is saved in ~/.claude_agennts_state"
        echo -e "and persists between terminal sessions."
        ;;
        
    *)
        # Spustit Claude v aktuálním režimu
        MODE=$(get_mode)
        
        # Zobrazit režim před spuštěním
        if [ "$MODE" = "AGENTS" ]; then
            echo -e "${YELLOW}[AGENTS]${RESET} Running Claude in AGENTS.md mode..."
            # Check if claude-agents-md is installed
            if command -v claude-agents-md &> /dev/null; then
                claude-agents-md "$@"
            else
                echo -e "${RED}Error: claude-agents-md is not installed${RESET}"
                echo -e "Install it with: ${CYAN}npm install -g claude-agents-md${RESET}"
                exit 1
            fi
        else
            echo -e "${CYAN}[CLAUDE]${RESET} Running Claude in CLAUDE.md mode..."
            # Check if claude is installed
            if command -v claude &> /dev/null; then
                claude "$@"
            else
                # If regular claude is not installed, use claude-agents-md with --claude flag
                if command -v claude-agents-md &> /dev/null; then
                    claude-agents-md --claude "$@"
                else
                    echo -e "${RED}Error: Neither claude nor claude-agents-md is installed${RESET}"
                    echo -e "Install claude-agents-md with: ${CYAN}npm install -g claude-agents-md${RESET}"
                    exit 1
                fi
            fi
        fi
        ;;
esac